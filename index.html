<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Mini-Gram Messenger</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0e1621; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #17212b; padding: 25px; border-radius: 15px; width: 450px; text-align: center; box-shadow: 0 5px 25px rgba(0,0,0,0.5); }
        input { width: 80%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; background: #242f3d; color: white; outline: none; }
        button { padding: 12px 20px; border: none; border-radius: 8px; background: #2b5278; color: white; cursor: pointer; font-weight: bold; margin-left: 5px; }
        button:hover { background: #36618e; }
        #chat-screen { display: none; }
        #chat-box { height: 350px; overflow-y: auto; background: #0e1621; padding: 15px; border-radius: 10px; margin: 15px 0; display: flex; flex-direction: column; border: 1px solid #242f3d; }
        .msg { margin: 5px 0; padding: 8px 12px; border-radius: 10px; max-width: 85%; word-wrap: break-word; text-align: left; position: relative; }
        .msg.me { background: #2b5278; align-self: flex-end; color: #fff; }
        .msg.other { background: #242f3d; align-self: flex-start; color: #fff; }
        .msg small { display: block; font-size: 0.7em; color: #82b1ff; margin-bottom: 4px; }
        .status-bar { font-size: 0.8em; color: #5288c1; margin-bottom: 10px; text-align: left; }
    </style>
</head>
<body>

<div id="auth-screen" class="card">
    <h2>Mini-Gram</h2>
    <p>Нажми кнопку и отправь код боту</p>
    <button onclick="startAuth()">Получить код</button>
    <h1 id="display-code" style="color: #5288c1; letter-spacing: 5px; font-size: 40px;"></h1>
    <p id="status" style="color: #aaa;"></p>
</div>

<div id="chat-screen" class="card">
    <div class="status-bar">
        Вы вошли как: <b id="my-name"></b>
    </div>
    
    <div style="display:flex; margin-bottom: 10px;">
        <input id="search-user" placeholder="Ник собеседника (без @)">
        <button onclick="loadChat()">Чат</button>
    </div>

    <div id="chat-box">
        <p style="color: #555; margin-top: 150px;">Введите ник и нажмите "Чат", чтобы начать</p>
    </div>

    <div style="display:flex; gap: 5px;">
        <input id="msg-input" placeholder="Сообщение..." onkeypress="if(event.key==='Enter') send()">
        <button onclick="send()" style="background: #5288c1;">Отправить</button>
    </div>
</div>

<script>
    let myUser = "";
    let chatWith = "";

    async function startAuth() {
        const res = await fetch('/request_code', {method:'POST'});
        const data = await res.json();
        document.getElementById('display-code').innerText = data.code;
        
        const authCheck = setInterval(async () => {
            const check = await fetch('/check_login/' + data.code);
            const res = await check.json();
            if(res.status === 'success') {
                clearInterval(authCheck);
                myUser = res.username;
                enterApp();
            }
        }, 2000);
    }

    function enterApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'block';
        document.getElementById('my-name').innerText = "@" + myUser;
        // Запускаем цикл обновления чата
        setInterval(loadChat, 3000);
    }

    async function loadChat() {
        chatWith = document.getElementById('search-user').value.trim();
        if(!chatWith) return;
        
        try {
            const res = await fetch(`/messages?me=${myUser}&with_user=${chatWith}`);
            const msgs = await res.json();
            const box = document.getElementById('chat-box');
            
            if (msgs.length === 0) {
                box.innerHTML = `<p style="color: #555; margin-top: 150px;">История сообщений с @${chatWith} пуста</p>`;
                return;
            }

            box.innerHTML = msgs.map(m => `
                <div class="msg ${m.sender === myUser ? 'me' : 'other'}">
                    <small>${m.sender}</small>
                    ${m.text}
                </div>
            `).join('');
            
            // Скролл вниз только если мы не листаем историю вверх
            box.scrollTop = box.scrollHeight;
        } catch (e) {
            console.error("Ошибка загрузки сообщений:", e);
        }
    }

    async function send() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        chatWith = document.getElementById('search-user').value.trim();

        if(!text) return;
        if(!chatWith) {
            alert("Сначала введите ник собеседника!");
            return;
        }
        
        try {
            const response = await fetch(`/send?sender=${myUser}&receiver=${chatWith}&text=${encodeURIComponent(text)}`, {method:'POST'});
            if (response.ok) {
                input.value = "";
                await loadChat(); // Сразу обновляем чат после отправки
            }
        } catch (e) {
            console.error("Ошибка отправки:", e);
        }
    }
</script>
</body>
</html>

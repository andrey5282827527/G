<style>
    #app-container { display: flex; height: 90vh; width: 900px; background: #17212b; border-radius: 15px; overflow: hidden; }
    #sidebar { width: 250px; border-right: 1px solid #0e1621; padding: 10px; overflow-y: auto; }
    #chat-main { flex-grow: 1; display: flex; flex-direction: column; padding: 15px; }
    .chat-item { padding: 10px; cursor: pointer; border-radius: 5px; margin-bottom: 5px; background: #242f3d; }
    .chat-item:hover { background: #2b5278; }
    .voice-btn { background: #cf3333; } /* –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏ */
</style>

<div id="auth-screen"> ... </div>

<div id="chat-screen" style="display:none;">
    <div id="app-container">
        <div id="sidebar">
            <h4 style="margin:0 0 10px 0;">–ú–æ–∏ —á–∞—Ç—ã</h4>
            <div id="chats-list"></div>
        </div>
        <div id="chat-main">
            <div id="my-name" style="font-weight:bold; color:#5288c1; margin-bottom:10px;"></div>
            <input id="search-user" placeholder="–ù–∞–π—Ç–∏ –Ω–∏–∫..." onkeypress="if(event.key==='Enter') loadChat()">
            <div id="chat-box" style="flex-grow:1; overflow-y:auto; background:#0e1621; margin:10px 0; border-radius:10px; padding:10px;"></div>
            <div style="display:flex; gap:5px;">
                <input id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="send()">></button>
                <button id="voice-btn" class="voice-btn" onmousedown="startVoice()" onmouseup="stopVoice()">üé§</button>
            </div>
        </div>
    </div>
</div>

<script>
    let myUser = localStorage.getItem('myUser');
    let chatWith = "";
    let mediaRecorder;
    let audioChunks = [];

    // –ï—Å–ª–∏ –Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å –≤ –ø–∞–º—è—Ç–∏, —Å—Ä–∞–∑—É –∑–∞—Ö–æ–¥–∏–º
    if(myUser) { enterApp(); }

    function enterApp() {
        localStorage.setItem('myUser', myUser);
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'block';
        document.getElementById('my-name').innerText = "@" + myUser;
        setInterval(updateSidebar, 3000);
        setInterval(loadChat, 3000);
    }

    async function updateSidebar() {
        const res = await fetch('/my_chats?me=' + myUser);
        const chats = await res.json();
        document.getElementById('chats-list').innerHTML = chats.map(c => `
            <div class="chat-item" onclick="selectChat('${c}')">@${c}</div>
        `).join('');
    }

    function selectChat(user) {
        document.getElementById('search-user').value = user;
        loadChat();
    }

    // –õ–û–ì–ò–ö–ê –ì–û–õ–û–°–û–í–´–•
    async function startVoice() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
            const blob = new Blob(audioChunks, { type: 'audio/ogg' });
            const formData = new FormData();
            formData.append('file', blob, 'voice.ogg');
            await fetch(`/send_voice?sender=${myUser}&receiver=${chatWith}`, { method: 'POST', body: formData });
            audioChunks = [];
            loadChat();
        };
        mediaRecorder.start();
    }
    function stopVoice() { mediaRecorder.stop(); }

    // –í loadChat –¥–æ–±–∞–≤–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞—É–¥–∏–æ
    // if(m.type === 'voice') return `<audio controls src="/get_voice?path=${m.text}"></audio>`;
</script>

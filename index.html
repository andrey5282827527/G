<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Messenger Premium</title>
    <style>
        :root { --bg: #0e1621; --sidebar-bg: #17212b; --active: #2b5278; --text: #ffffff; --msg-me: #2b5278; --msg-other: #182533; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 320px; background: var(--sidebar-bg); border-right: 1px solid #000; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #0e1621; }
        .chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #0e1621; }
        .chat-item:hover { background: #242f3d; }
        .chat-item.active { background: var(--active); }

        /* Main Chat */
        .main-chat { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 15px; background: var(--sidebar-bg); display: flex; justify-content: space-between; align-items: center; }
        .messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .message { max-width: 75%; padding: 8px 15px; border-radius: 12px; position: relative; }
        .message.me { align-self: flex-end; background: var(--msg-me); }
        .message.other { align-self: flex-start; background: var(--msg-other); }
        
        /* Controls */
        .input-area { padding: 15px; background: var(--sidebar-bg); display: flex; gap: 10px; align-items: center; }
        input { flex-grow: 1; background: var(--bg); border: none; color: white; padding: 12px; border-radius: 8px; outline: none; }
        .btn { background: #5288c1; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; }
        .voice-btn { background: #cf3333; width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; color: white; }
        
        /* Auth */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        
        .sticker-img { width: 120px; height: 120px; display: block; }
    </style>
</head>
<body>

<div id="auth-screen">
    <h1>G-Messenger</h1>
    <button class="btn" onclick="startAuth()">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –¥–ª—è –≤—Ö–æ–¥–∞</button>
    <h2 id="display-code" style="letter-spacing: 5px; color: #5288c1;"></h2>
    <p id="status">–ó–∞–π–¥–∏—Ç–µ –≤ –±–æ—Ç–∞ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –µ–º—É –∫–æ–¥</p>
</div>

<div class="sidebar">
    <div class="sidebar-header">
        <div id="my-nick">@loading...</div>
        <div style="margin-top:10px; display: flex; gap: 5px;">
            <button class="btn" onclick="newPrivateChat()">üîç –õ–°</button>
            <button class="btn" onclick="createNewGroup()">üë• –ì—Ä—É–ø–ø–∞</button>
        </div>
    </div>
    <div id="chat-list" class="chat-list"></div>
    <div style="padding: 10px;">
        <button class="btn" style="width: 100%; background: #4a4a4a;" onclick="manageStickers()">üñº –ú–æ–∏ —Å—Ç–∏–∫–µ—Ä—ã</button>
    </div>
</div>

<div class="main-chat">
    <div class="chat-header">
        <span id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</span>
        <button id="admin-add-btn" class="btn" style="display:none;" onclick="addUserToGroup()">+ –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
    </div>
    <div id="messages" class="messages"></div>
    <div class="input-area">
        <button class="btn" onclick="showStickerPanel()">üòä</button>
        <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendText()">
        <button id="voice-btn" class="voice-btn" onmousedown="startVoice()" onmouseup="stopVoice()">üé§</button>
        <button class="btn" onclick="sendText()">></button>
    </div>
</div>

<script>
    let myUser = localStorage.getItem('g_user');
    let currentChat = "";
    let mediaRecorder;
    let chunks = [];

    if (myUser) loginSuccess(myUser);

    async function startAuth() {
        const res = await fetch('/request_code', {method:'POST'});
        const data = await res.json();
        document.getElementById('display-code').innerText = data.code;
        const check = setInterval(async () => {
            const r = await fetch('/check_login/' + data.code);
            const d = await r.json();
            if (d.status === 'success') { clearInterval(check); loginSuccess(d.username); }
        }, 2000);
    }

    function loginSuccess(user) {
        myUser = user;
        localStorage.setItem('g_user', user);
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('my-nick').innerText = "@" + myUser;
        updateSidebar();
        setInterval(loadMessages, 2500);
    }

    async function updateSidebar() {
        const res = await fetch('/list_rooms');
        const rooms = await res.json();
        const list = document.getElementById('chat-list');
        list.innerHTML = rooms.map(r => `
            <div class="chat-item ${currentChat === r.name ? 'active' : ''}" onclick="selectChat('${r.name}', true)">
                <b># ${r.name}</b><br><small>–≥—Ä—É–ø–ø–∞</small>
            </div>
        `).join('');
    }

    function newPrivateChat() {
        const who = prompt("–ù–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:");
        if (who) selectChat(who, false);
    }

    function selectChat(name, isGroup) {
        currentChat = name;
        document.getElementById('chat-title').innerText = (isGroup ? "–ì—Ä—É–ø–ø–∞: " : "–ß–∞—Ç —Å: ") + name;
        document.getElementById('admin-add-btn').style.display = isGroup ? 'block' : 'none';
        loadMessages();
    }

    async function loadMessages() {
        if (!currentChat) return;
        const res = await fetch(`/messages?me=${myUser}&target=${currentChat}`);
        const msgs = await res.json();
        const box = document.getElementById('messages');
        box.innerHTML = msgs.map(m => `
            <div class="message ${m.sender === myUser ? 'me' : 'other'}">
                <div style="font-size: 10px; opacity: 0.5;">${m.sender}</div>
                ${renderMessageContent(m)}
            </div>
        `).join('');
        box.scrollTop = box.scrollHeight;
    }

    function renderMessageContent(m) {
        if (m.type === 'voice') return `<audio controls src="/get_voice?path=${m.text}"></audio>`;
        if (m.type === 'sticker') return `<img class="sticker-img" src="/get_voice?path=${m.text}">`;
        return m.text;
    }

    async function sendText() {
        const inp = document.getElementById('msg-input');
        if (!inp.value || !currentChat) return;
        await fetch(`/send?sender=${myUser}&receiver=${currentChat}&text=${encodeURIComponent(inp.value)}`, {method:'POST'});
        inp.value = "";
        loadMessages();
    }

    // –°–¢–ò–ö–ï–†–´ –° –ü–†–û–í–ï–†–ö–û–ô –î–û–°–¢–£–ü–ê
    async function manageStickers() {
        const pack = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç–∏–∫–µ—Ä–ø–∞–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 656):");
        if (!pack) return;
        
        // –í–ê–ñ–ù–û: –ú—ã –ø–µ—Ä–µ–¥–∞–µ–º myUser, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –ø—Ä–æ–≤–µ—Ä–∏–ª, —Ç–≤–æ–π –ª–∏ —ç—Ç–æ –ø–∞–∫
        const action = confirm("–•–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å—Ç–∏–∫–µ—Ä –≤ —ç—Ç–æ—Ç –ø–∞–∫?");
        if (action) {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = async () => {
                const fd = new FormData();
                fd.append('file', input.files[0]);
                // –°–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–≤–µ—Ä—è—Ç—å owner –≤ create_sticker
                const res = await fetch(`/create_sticker?pack=${pack}&owner=${myUser}`, {method:'POST', body:fd});
                const data = await res.json();
                if(data.error) alert("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω! –≠—Ç–æ—Ç –ø–∞–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª–µ—Ü.");
                else alert("–°—Ç–∏–∫–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω!");
            };
            input.click();
        }
    }

    // –ì–û–õ–û–°–û–í–´–ï
    async function startVoice() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.ondataavailable = e => chunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'audio/ogg' });
                const fd = new FormData();
                fd.append('file', blob, 'v.ogg');
                await fetch(`/send_voice?sender=${myUser}&receiver=${currentChat}`, {method:'POST', body:fd});
                chunks = [];
                loadMessages();
            };
            mediaRecorder.start();
        } catch(e) { alert("–í–∫–ª—é—á–∏—Ç–µ HTTPS –∏–ª–∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ!"); }
    }
    function stopVoice() { if(mediaRecorder) mediaRecorder.stop(); }
</script>
</body>
</html>

<script>
    let myUser = localStorage.getItem('chat_user'); // Проверяем память
    let currentChat = "";
    let mediaRecorder;
    let chunks = [];

    window.onload = () => {
        if(myUser) enterApp(); // Если залогинен, сразу в чат
    };

    function enterApp() {
        localStorage.setItem('chat_user', myUser);
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'flex';
        document.title = "Чат: " + myUser;
        setInterval(loadMessages, 2000);
        loadRooms();
    }

    // ГОЛОСОВЫЕ (Зажать кнопку)
    async function startRecord() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, { type: 'audio/ogg' });
            const fd = new FormData();
            fd.append('file', blob, 'voice');
            await fetch(`/send_voice?sender=${myUser}&receiver=${currentChat}`, {method:'POST', body:fd});
            chunks = [];
        };
        mediaRecorder.start();
    }

    function stopRecord() { mediaRecorder.stop(); }

    // ГРУППЫ
    async function createRoom(type) {
        const name = prompt("Название:");
        if(name) await fetch(`/create_room?name=${name}&owner=${myUser}&rtype=${type}`, {method:'POST'});
    }
</script>

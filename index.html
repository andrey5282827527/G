<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mini-Gram TG Auth</title>
    <style>
        body { font-family: sans-serif; background: #0e1621; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: #17212b; padding: 30px; border-radius: 15px; width: 400px; text-align: center; }
        input { width: 80%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; background: #242f3d; color: white; }
        button { padding: 10px 20px; border: none; border-radius: 5px; background: #2b5278; color: white; cursor: pointer; }
        #chat-box { height: 300px; overflow-y: auto; text-align: left; background: #0e1621; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="auth-screen" class="card">
    <h2>Вход через Telegram</h2>
    <p>Нажми кнопку и отправь полученный код боту</p>
    <button onclick="startAuth()">Получить код</button>
    <h1 id="display-code" style="color: #5288c1;"></h1>
    <p id="status"></p>
</div>

<div id="chat-screen" class="card" style="display:none; width: 500px;">
    <h3 id="my-name"></h3>
    <input id="search-user" placeholder="Кому пишем? (username без @)">
    <button onclick="loadChat()">Найти/Открыть</button>
    <hr>
    <div id="chat-box"></div>
    <div style="display:flex">
        <input id="msg-input" placeholder="Сообщение...">
        <button onclick="send()">></button>
    </div>
</div>

<script>
    let myUser = "";
    let chatWith = "";
    let authInterval;

    async function startAuth() {
        const res = await fetch('/request_code', {method:'POST'});
        const data = await res.json();
        document.getElementById('display-code').innerText = data.code;
        document.getElementById('status').innerText = "Жду подтверждения в боте...";
        
        authInterval = setInterval(async () => {
            const check = await fetch('/check_login/' + data.code);
            const res = await check.json();
            if(res.status === 'success') {
                clearInterval(authInterval);
                myUser = res.username;
                showChat();
            }
        }, 3000);
    }

    function showChat() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('chat-screen').style.display = 'block';
        document.getElementById('my-name').innerText = "Ты: @" + myUser;
    }

    async function loadChat() {
        chatWith = document.getElementById('search-user').value;
        const res = await fetch(`/messages?me=${myUser}&with_user=${chatWith}`);
        const msgs = await res.json();
        const box = document.getElementById('chat-box');
        box.innerHTML = msgs.map(m => `<div><b>${m.sender}:</b> ${m.text}</div>`).join('');
        box.scrollTop = box.scrollHeight;
    }

    async function send() {
        const text = document.getElementById('msg-input').value;
        await fetch(`/send?sender=${myUser}&receiver=${chatWith}&text=${text}`, {method:'POST'});
        document.getElementById('msg-input').value = "";
        loadChat();
    }
</script>
</body>
</html>
